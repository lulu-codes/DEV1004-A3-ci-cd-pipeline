# Docker Compose file for "The Century Screening Room" full stack MERN app
# This runs 3 containers including the Frontend (React/Vite), Backend (Express.js) and MongoDB (database)
# Containers communicate through Docker's internal network using service names

name: century-screening-room-dev

# These are all the services that will run as containers
services:
  # Backend API container
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
      args:
        NODE_ENV: development

    image: century-screening-room-backend:dev-v1.0
    container_name: century-screening-room-backend-dev

    ports:
      - "3000:3000"

    environment:
      - HOST=0.0.0.0
      - NODE_ENV=development
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev_secret_key_change_in_production}
      - DATABASE_URI=mongodb://mongodb:27017/movie_db
      - LOCAL_DB_URI=mongodb://mongodb:27017/movie_db
      - OMDB_API_KEY=${OMDB_API_KEY:-}
      - TOKEN_HEADER_KEY=authorization

    # Backend needs database to be ready first
    depends_on:
      - mongodb

    # Health check to make sure backend is responding before dependant services (like frontend) try to connect
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    # Connects backend to app-network so frontend can reach it
    networks:
      - app-network

  # MongoDB database container
  mongodb:
    image: mongo:7.0
    container_name: mongodb-dev

    ports:
      - "27017:27017"

    environment:
      # Creates the database on first startup
      - MONGO_INITDB_DATABASE=movie_db

    volumes:
      # This keeps data even if container stops (otherwise all data disappears when container is removed)
      - mongodb_data:/data/db

    # Checks if mongodb is responding
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

    restart: unless-stopped

    networks:
      - app-network

  # Frontend container
  frontend:
    build:
      context: ./frontend/
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:3000

    image: century-screening-room-frontend:dev-v1.0
    container_name: century-screening-room-frontend-dev

    # Maps port 5000 on my computer to port 5000 in container
    ports:
      - "5000:5000"

    # Sets the environment variables for the container
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000

    # Makes sure backend container starts first
    depends_on:
      - backend

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    networks:
      - app-network

# Persistant data storage for MongoBD
volumes:
  mongodb_data:
    name: century-screening-room-mongodb-data

# Network for the containers to communicate with each other without exposing ports
networks:
  app-network:
    # Creates a bridge network named "century-screening-room-network"
    name: century-screening-room-network
    driver: bridge
